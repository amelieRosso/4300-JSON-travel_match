<!DOCTYPE html>
<title>{% block title %}{% endblock %} - Flaskr</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Kanit&family=Montserrat&family=Open+Sans:wght@500&display=swap"
  rel="stylesheet"
/>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>
      Zoom to a location | Sample | ArcGIS Maps SDK for JavaScript 4.32
    </title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.32/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.32/"></script>

    <script>
      let view;

      function createMap() {
        require(["esri/Map", "esri/views/SceneView"], (Map, SceneView) => {
          const map = new Map({
            basemap: "topo-3d",
            zoom: 10,
          });

          view = new SceneView({
            container: "map",
            map: map,
          });
        });
      }

      function mapPoint(lat_long_list) {
        view.graphics.removeAll()
        pointGraphics = [];
        lat_long_list?.forEach((site) => {
            const longitude = site[0]
            const latitude = site[1]
          require(["esri/Graphic"], (Graphic) => {
            console.log("longitude" + longitude);
            console.log("latitude" + latitude);

            const point = {
              type: "point",
              longitude: longitude,
              latitude: latitude,
            };

            const markerSymbol = {
              type: "picture-marker", // autocasts as new PictureMarkerSymbol()
              url: "http://static.arcgis.com/images/Symbols/Basic/RedStickpin.png",
              width: "32px",
              height: "32px",
            };

            // Create a graphic and add the geometry and symbol to it
            const pointGraphic = new Graphic({
              geometry: point,
              symbol: markerSymbol,
            });

            pointGraphics.push(pointGraphic);
          });
          view.graphics.addMany(pointGraphics);

          if (lat_long_list.length > 0) {
            console.log("hi");
            zoomToPoint(lat_long_list[0][0], lat_long_list[0][1])
          }

        });
      }

      function zoomToPoint(longitude, latitude) {
        view.goTo({
            center: [longitude, latitude],
            zoom: 5
        });
        //view.when(() => view.goTo(point));
      }

      createMap();

      //if (site_lang_long_list.length > 0) {
      //  zoomToPoint(site_lang_long_list[0][0], site_lang_long_list[0][1]);
      //}

      //site_lang_long_list is a list of tuples (latitude, longitude)
      //const longitude = parseFloat(searchParams.get("long") ?? -117.2);
      //const latitude = parseFloat(searchParams.get("lat") ?? 34.1);

      let debounceTimeout;

      // js code for showing more or less information.
      function readMore(dotsId, moreId, btnId, textOpen, textClose) {
        const dots = document.getElementById(dotsId);
        const moreText = document.getElementById(moreId);
        const btnText = document.getElementById(btnId);
        if (dots.style.display === "none") {
          dots.style.display = "inline";
          btnText.innerHTML = textOpen;
          moreText.style.display = "none";
        } else {
          dots.style.display = "none";
          btnText.innerHTML = textClose;
          moreText.style.display = "inline";
        }
      }

      // All the html and js logic for the information in the answer cards.
      function answerBoxTemplate(
        name,
        description,
        rating,
        reviews,
        similarity_score,
        tags,
        id,
        inscribe_date,
        category,
        country,
        region,
        isoCodes
      ) {
        const tagHtml =
          tags && tags.length > 0
            ? tags.map((tag) => `<span class="tag">#${tag}</span>`).join(" ")
            : `<span>No tags available</span>`;

        const flagsHtml = (isoCodes || [])
          .map(
            (code) =>
              `<img class="flag_icon" src="/static/images/${code}.svg" alt="${code} flag" />`
          )
          .join(" ");

        function renderStarIcons(rating) {
          if (!rating || isNaN(rating)) return "No ratings available";
          const full = Math.floor(rating);
          const half = rating % 1 >= 0.5;
          const empty = 5 - full - (half ? 1 : 0);

          return (
            '<span class="star full"></span>'.repeat(full) +
            (half ? '<span class="star half"></span>' : "") +
            '<span class="star empty"></span>'.repeat(empty) +
            ` <span class="numeric-rating">(${rating})</span>`
          );
        }

        const filteredReviews = (reviews || []).filter(
          (r) => r && r.trim().length > 0
        );
        // const previewIndex = Math.min(description.length, 200);
        // const descriptionPreview = description.slice(0, previewIndex);
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = description;
        const fullText = tempDiv.innerText || tempDiv.textContent || "";
        const words = fullText.split(/\s+/);
        const previewWordCount = 40;
        const previewWords = words.slice(0, previewWordCount).join(" ");
        const remainingWords = words.slice(previewWordCount).join(" ");

        const reviewHtml =
          filteredReviews.length > 0
            ? `<ol>${filteredReviews.map((r) => `<li>${r}</li>`).join("")}</ol>`
            : `<span>No reviews yet.</span>`;

        return `
          <div class='imageContainer'>
              <img class="siteImage" src="/static/images/${id}.jpg" alt="Site image for ${name}"/>
              <p class="category ${category}"> ${category}</p>
              <p class="similarity_score ${
                similarity_score >= 70
                  ? "High"
                  : similarity_score > 40
                  ? "Moderate"
                  : "Low"
              }"> Similarity: ${similarity_score}</p>
          </div>
          <div class='answerCard'>
          <div class="site_title_with_flag">${flagsHtml}</div>
          <h3 class='site_name'>${name}</h3>
          <div class='short_description'>${previewWords}
              <span id="dots-${id}">...</span>
              <span id="more-${id}" style="display:none">${remainingWords}</span>
          </div>
          <button onclick="readMore('dots-${id}', 'more-${id}', 'mybtn-${id}', 'Read more', 'Read less')" class="moreBtn" id="mybtn-${id}">Read more</button>
          <div class='extra_info'>
              <p class='google_rating'>Google Rating: 
                  ${
                    rating != null
                      ? `
                  <input
                  class="rating"
                  type="range"
                  max="5"
                  readonly
                  step="0.01"
                  style="--value:${rating}"
                  value="${rating}"
                  title="${rating} stars"
                  />`
                      : "No ratings available"
                  } 
                  ${rating != null ? rating : ""}
              </p>

              <div class='reviews'>
                  <strong>Google Reviews:</strong> <span id="review-dots-${id}"></span> 
                  <button onclick="readMore('review-dots-${id}', 'review-more-${id}', 'review-mybtn-${id}', 'See reviews', 'Hide reviews')"
                      class="moreBtn" id="review-mybtn-${id}">See reviews</button> 

                  <span id="review-more-${id}" style="display:none">
                  ${reviewHtml}
                  </span>
              </div>

              <p class="tags"> Tags: ${tagHtml}</p>
              <p class="inscribe-date"> Inscribe Date: ${inscribe_date}</p>
              <p class="country"> Country: ${country}</p>
              <p class="country"> Region: ${region}</p>
          </div>                
      </div>`;
      }

      function sendFocus() {
        document.getElementById("filter-text-val").focus();
      }

      function filterText() {
        // Clear existing debounce timer
        clearTimeout(debounceTimeout);

        // Set a new debounce timer
        debounceTimeout = setTimeout(() => {
          const query = document.getElementById("filter-text-val").value;
          if (query.length === 0) {
            document.getElementById("answer-box").innerHTML = "";
            return;
          }

          console.log("Searching:", query);

          const country = document.getElementById("country-filter").value;
          const category = document.getElementById("category-filter").value;
          const mode = document.getElementById("search-mode").value;
          const params = new URLSearchParams({
            title: query,
            country: country,
            category: category,
            mode: mode,
          });

          fetch("/episodes?" + params.toString())
            .then((response) => response.json())
            .then((data) => {
              const container = document.getElementById("answer-box");
              container.innerHTML = ""; // Clear previous results
              // This issue doesn't really happen, the console always shows a length of 10 even for unexpected searches
              //TODO: if all the similarity scores are 0 then show no results found
              if (data?.length == 0) {
                let tempDiv = document.createElement("div");
                tempDiv.classList.add("answerContainer");
                tempDiv.innerHTML = `<div class='answerCard'>
                      <h3 class='site_name'>No results found.</h3>
                      <div class='short_description'>Try a different search.</div>
                  </div>`;
                container.appendChild(tempDiv);
                return;
              }
              let tempDiv = document.createElement("div");
              tempDiv.setAttribute("id", "answer-amount");
              tempDiv.innerHTML = `<h3>${data?.length} Sites Found </h3>`;
              container.appendChild(tempDiv);

              data?.forEach((row) => {
                let tempDiv = document.createElement("div");
                tempDiv.classList.add("answerContainer");
                tempDiv.innerHTML = answerBoxTemplate(
                  row.Name,
                  row["Short Description"],
                  row.Rating,
                  row.Reviews,
                  row.Similarity_Score,
                  row.Tags,
                  row.id,
                  row["Inscribe Date"],
                  row.Category,
                  row.Country,
                  row.Region,
                  row.ISO_Codes
                );
                container.appendChild(tempDiv);
              });

              let lat_long_list = [];
              data?.forEach((row) => {
                lat_long_list.push([row["longitude"], row["latitude"]]);
                console.log(row["Name"])
              });

              mapPoint(lat_long_list);
            });
        }, 200); // Only search after user stops typing for 200ms
      }

      window.addEventListener("DOMContentLoaded", () => {
        fetch("/filters")
          .then((res) => res.json())
          .then((data) => {
            const countryList = document.getElementById("country-list");
            const categoryList = document.getElementById("category-list");

            (data.countries || []).forEach((country) => {
              const option = document.createElement("option");
              option.value = country;
              countryList.appendChild(option);
            });

            (data.categories || []).forEach((category) => {
              const option = document.createElement("option");
              option.value = category;
              categoryList.appendChild(option);
            });
          });
      });
    </script>
  </head>

  <body>
    <div class="full-body-container">
      <!-- <img src="{{ url_for('static', filename='images/title_background.png') }}" /> -->
      <div class="background">
        <div class="top-text">
          <h1>World Heritage Search</h1>
          <div class="tagline">
            <h2>
              Browse through our collection of UNESCO sites and find your next
              travel destination.
            </h2>
          </div>
          <div class="input-row">
            <div class="input-container">
              <button type="submit" onClick="filterText()">
                <img
                  src="{{ url_for('static', filename='images/arrow_icon.png') }}"
                  alt="buttonpng"
                />
              </button>
              <div class="input-box" onclick="sendFocus()">
                <input
                  placeholder="Search for your next UNESCO heritage sites... (e.g. sea, mountain, historic)"
                  id="filter-text-val"
                  onkeyup="filterText()"
                />
              </div>
            </div>
            <div class="dropdowns-inline">
              <input
                list="country-list"
                id="country-filter"
                placeholder="Filter by country"
                oninput="filterText()"
              />
              <datalist id="country-list"></datalist>

              <input
                list="category-list"
                id="category-filter"
                placeholder="Filter by category"
                oninput="filterText()"
              />
              <datalist id="category-list"></datalist>

              <select id="search-mode" onchange="filterText()">
                <option value="svd">SVD search</option>
                <option value="bert">BERT Embedding search</option>
              </select>
            </div>
          </div>
        </div>
        <div id="answer-box"></div>
      </div>
    </div>

    <div id="map"></div>
  </body>
</html>
